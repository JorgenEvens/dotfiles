#!/bin/sh
export PATH=$PATH:/usr/local/bin

# abort if we're already inside a TMUX session
[ "$TMUX" == "" ] || exit 0

SESSION_PREFIX="unnamed"
HAD_SESSION=0

launch_zsh() {
    HAD_SESSION=1
    zsh --login
}

launch_tmux() {
    HAD_SESSION=1
    tmux -2 "$@"
}

attach_tmux() {
    launch_tmux attach-session -t "$1"
}

launch_named_tmux() {
    tmux has-session -t "$1" 2>&1 > /dev/null
    if [ $? -eq 0 ]; then
        attach_tmux "$1"
    else
        launch_tmux new -s "$1"
    fi
}

launch_unnamed_tmux() {
    launch_named_tmux "${SESSION_PREFIX}_${#SESSIONS[@]}"
}

# present menu for user to choose which workspace to open
while true; do
    # TMOUT=5 # Timeout after 5 seconds and open a new tmux session
    SESSIONS=($(tmux list-sessions -F '#S'))
    test ${#SESSIONS} -lt 1 && SESSIONS=("")
    PS3="Please choose your session: "
    echo "Options"
    echo "------------------"
    echo "n) new session"
    echo "z) zsh"
    echo "q) quit"
    echo ""
    echo "Available sessions"
    echo "------------------"
    select opt in "${SESSIONS[@]}"
    do
        case $opt in
            "")
                case "$REPLY" in
                    "") launch_unnamed_tmux;;
                    "n") launch_unnamed_tmux;;
                    "z") launch_zsh;;
                    "q") exit;;
                    "quit") exit;;
                    *) launch_named_tmux "$REPLY"
                esac
                ;;
            *)
                attach_tmux $opt
                ;;
        esac
        break
    done

    if [ ! $? -eq 0 ]; then
        # Leave shell if we are leaving a shell
        test $HAD_SESSION -gt 0 && exit

        launch_unnamed_tmux
    fi
done
